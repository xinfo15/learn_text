<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>判断两个文件是否相同</title>
    <style>
      html {
        background-color: rgb(238, 238, 238);
      }
      body {
        width: 70%;
        margin: 0 auto;
      }
      header {
        margin: 20px 0;
        font-size: 30px;
        text-align: center;
        padding: 30px 0;
        background-color: white;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
      }

      .wrapper {
        display: flex;
        justify-content: space-around;
      }

      .file1-box,
      .file2-box {
        flex: 1;
        min-height: 400px;
        box-sizing: border-box;
        font-size: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 30px;
        /* border: 10px dashed; */
        background-color: white;
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.2);
      }

      .file1-box {
        /* border-color: rgb(255, 255, 27); */
        margin-right: 100px;
      }

      .file2-box {
        /* border-color: yellowgreen; */
      }

      button,
      #res:not(:empty) {
        margin-top: 20px;
        font-size: 30px;
        width: 100%;
        min-height: 50px;
        
        background-color: rgb(255, 255, 255);
        box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.2);
        border: none;
        padding: 10px;
        box-sizing: border-box;
      }
      
      button {
        cursor: pointer;
        background-color: rgb(24,144,255);
        color: white;
        border-radius: 8px;
      }

      .error {
        color: red;
      }
      .success {
        color: green;
      }
    </style>
  </head>
  <body>
    <header>判断两个文件是否相同，如果不同，输出不同的字节和不同的字符</header>
    <div class="wrapper">
      <div class="file file1-box">请拖入第一个文件</div>
      <div class="file file2-box">请拖入第二个文件</div>
    </div>

    <button>比较两个文件</button>

    <div id="res"></div>

    <script>
      const fileBoxes = document.querySelectorAll('.file')
      const btn = document.querySelector('button')
      btn.addEventListener('click', compare, false)
      // 输出信息的盒子
      const resBox = document.querySelector('#res')

      // 为文件盒子绑定拖入文件功能
      for (const fileBox of fileBoxes) {
        fileBox.addEventListener(
          'dragover',
          function (e) {
            e.stopPropagation()
            e.preventDefault()
          },
          false
        )

        fileBox.addEventListener(
          'drop',
          function (e) {
            e.stopPropagation()
            e.preventDefault()

            const file = e.dataTransfer.files[0]
            console.log(file)

            fileBox.file = file
            fileBox.innerHTML = '文件名：' + file.name

            // 通过数组缓存读取文件
            const frArrBuffer = new FileReader()

            frArrBuffer.onload = function () {
              console.log(this.result)

              fileBox.arrayBuffer = this.result
              fileBox.innerHTML += '<br>' + '文件大小：' + this.result.byteLength + '字节'
            }

            // 通过字符读取文件
            frArrBuffer.readAsArrayBuffer(file)
            const frString = new FileReader()
            frString.onload = function () {
              fileBox.string = this.result
            }
            frString.readAsText(file)

            // 清空输出的消息
            resBox.innerHTML = ''
          },
          false
        )
      }

      //字符串转字符串ArrayBuffer
      function strToArrBuffer(s) {
        return new Promise((resolve) => {
          var b = new Blob([s], { type: 'text/plain' })
          var r = new FileReader()
          r.readAsArrayBuffer(b)
          r.onload = function () {
            resolve(this.result)
          }
        })
      }

      // 找到当前字节，对应的字符
      function findChar(arr, n, string) {
        // 从后往前找，找第到第一个字节比他小的后一个，就是对应的字符范围内的字节
        for (let i = arr.length - 1; i >= 0; i--) {
          if (arr[i] < n) {
            // 由于byteMapCharTwo数组为了方便计算前缀和，所以下标从1开始；而string下标还是从0开始，所以需要减1
            i += 1
            // 字符不存在
            if (string[i - 1] === undefined) break

            return `对应文件的第 ${i} 个字符：${string[i - 1]}`
          }
        }

        return '"[System Message:对应字符不存在]"'
      }

      function binaryFindChar(arr, n, string) {
        
      }

      // 比较两个文件的不同
      async function compare() {
        // 读取文件数据的存储位置
        const fileBoxOne = document.querySelector('.file1-box')
        const fileBoxTwo = document.querySelector('.file2-box')
        // 读取文件的缓存
        const fileBufferOne = fileBoxOne.arrayBuffer
        const fileBufferTwo = fileBoxTwo.arrayBuffer

        if (!(fileBufferOne && fileBufferTwo)) {
          alert('请选择两个文件后，再点击比较！')
          return
        }

        // 读取文件的字符
        const fileStringOne = fileBoxOne.string
        const fileStringTwo = fileBoxTwo.string

        // 文件字节映射到字符的数组
        const byteMapCharOne = [0]
        const byteMapCharTwo = [0]

        // 读取文件的字节
        const fileByteArrOne = new Uint8Array(fileBufferOne)
        const fileByteArrTwo = new Uint8Array(fileBufferTwo)

        // 显示文件不相同的错误信息
        function showError(byte) {
          resBox.innerHTML = `两个文件在第 ${byte} 个字节处发生不同<br>第一个文件的第 ${byte} 字节为：${fileByteArrOne[idx] ?? '"[System Message:不存在]"'}，\t ${findChar(byteMapCharOne, byte, fileStringOne)}<br>第二个文件的第 ${byte} 字节为：${
            fileByteArrTwo[idx] ?? '"[System Message:不存在]"'
          }，\t ${findChar(byteMapCharTwo, byte, fileStringTwo)}`
          resBox.className = 'error'
        }

        // 创建字节映射字符的关系数组
        for (const char of fileStringOne) {
          const res = await strToArrBuffer(char)
          byteMapCharOne.push(res.byteLength + byteMapCharOne[byteMapCharOne.length - 1])
        }
        for (const char of fileStringTwo) {
          const res = await strToArrBuffer(char)
          byteMapCharTwo.push(res.byteLength + byteMapCharTwo[byteMapCharTwo.length - 1])
        }

        console.log(byteMapCharOne, byteMapCharTwo)

        // 字节序号，从0开始
        let idx = 0

        // 查找两个文件中对应字符是否一样
        while (idx < fileByteArrOne.length && idx < fileByteArrTwo.length) {
          if (fileByteArrOne[idx] !== fileByteArrTwo[idx]) {
            showError(idx + 1)
            return
          }
          idx++
        }

        // 如果两个文件字节大小不一样
        if (idx < fileByteArrOne.length) {
          showError(fileByteArrTwo.length + 1)
        } else if (idx < fileByteArrTwo.length) {
          showError(fileByteArrOne.length + 1)
        } else {
          // 两个文件完全一样
          resBox.innerHTML = `两个文件字节完全相同！`
          resBox.className = 'success'
        }
      }
    </script>
  </body>
</html>
